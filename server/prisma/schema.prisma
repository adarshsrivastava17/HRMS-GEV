// Prisma Schema for GEV System
// Using SQLite for local development - use PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./hrms.db"
}

// User Model - Supports all 4 roles
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  role          String   @default("employee") // admin, manager, hr, employee
  accountStatus String   @default("approved") // pending, approved, rejected
  position      String?
  phone         String?
  avatar        String?
  salary        Float?
  joiningDate   DateTime @default(now())
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  managerId    String?
  
  // Related records
  attendances     Attendance[]
  leaveRequests   LeaveRequest[]  @relation("UserLeaves")
  approvedLeaves  LeaveRequest[]  @relation("ApprovedLeaves")
  performances    Performance[]   @relation("UserPerformances")
  reviewedPerfs   Performance[]   @relation("ReviewedPerformances")
  tasksAssigned   Task[]          @relation("AssignedTasks")
  tasksCreated    Task[]          @relation("CreatedTasks")
  payrolls        Payroll[]
  announcements   Announcement[]
  passwordResets  PasswordReset[] @relation("UserResets")
  approvedResets  PasswordReset[] @relation("ApprovedResets")

  @@index([role])
  @@index([departmentId])
}

// Password Reset Request Model
model PasswordReset {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation("UserResets", fields: [userId], references: [id], onDelete: Cascade)
  status     String    @default("pending") // pending, approved, rejected
  approvedBy String?
  approver   User?     @relation("ApprovedResets", fields: [approvedBy], references: [id])
  approvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([status])
}

// Department Model
model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

// Attendance Model with Break Tracking
model Attendance {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date           DateTime @default(now())
  checkIn        DateTime?
  checkOut       DateTime?
  status         String   @default("present") // present, absent, half-day, on-leave
  totalWorkTime  Int      @default(0) // in minutes
  totalBreakTime Int      @default(0) // in minutes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  breaks Break[]

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Break Model for tracking individual breaks
model Break {
  id           String     @id @default(uuid())
  attendanceId String
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  startTime    DateTime
  endTime      DateTime?
  duration     Int        @default(0) // in minutes
  createdAt    DateTime   @default(now())

  @@index([attendanceId])
}

// Leave Request Model
model LeaveRequest {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation("UserLeaves", fields: [userId], references: [id], onDelete: Cascade)
  type       String   // sick, casual, annual, maternity, paternity
  startDate  DateTime
  endDate    DateTime
  reason     String
  status     String   @default("pending") // pending, approved, rejected
  approvedBy String?
  approver   User?    @relation("ApprovedLeaves", fields: [approvedBy], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// Performance Review Model
model Performance {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation("UserPerformances", fields: [userId], references: [id], onDelete: Cascade)
  reviewerId  String
  reviewer    User     @relation("ReviewedPerformances", fields: [reviewerId], references: [id])
  period      String   // Q1-2024, Q2-2024, etc.
  rating      Int      // 1-5
  goals       String?
  achievements String?
  feedback    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// Task Assignment Model
model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  assigneeId  String
  assignee    User     @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: Cascade)
  assignerId  String
  assigner    User     @relation("CreatedTasks", fields: [assignerId], references: [id])
  priority    String   @default("medium") // low, medium, high, urgent
  status      String   @default("pending") // pending, in-progress, completed
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([assigneeId])
  @@index([status])
}

// Payroll Model
model Payroll {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month        String   // 2024-01, 2024-02, etc.
  basicSalary  Float
  bonus        Float    @default(0)
  deductions   Float    @default(0)
  netSalary    Float
  status       String   @default("pending") // pending, processed, paid
  paidDate     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId])
}

// Announcement Model
model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  priority  String   @default("normal") // low, normal, high, urgent
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// Team Model for Manager Team Management
model Team {
  id          String       @id @default(uuid())
  name        String
  description String?
  managerId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  members     TeamMember[]

  @@index([managerId])
}

// Team Member Junction Table
model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  role      String   @default("member") // member, lead
  joinedAt  DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// Hiring/Job Posting Model
model Hiring {
  id           String   @id @default(uuid())
  title        String
  department   String
  location     String
  type         String   // full-time, part-time, contract, internship
  salaryRange  String?
  description  String
  requirements String
  status       String   @default("open") // open, closed, on-hold
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
  @@index([createdById])
}
